<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><defs><linearGradient id=%22g%22 x1=%220%25%22 y1=%220%25%22 x2=%22100%25%22 y2=%22100%25%22><stop offset=%220%25%22 stop-color=%22%232477d4%22/><stop offset=%22100%25%22 stop-color=%22%230ea8a8%22/></linearGradient></defs><rect width=%22100%22 height=%22100%22 rx=%2218%22 fill=%22url(%23g)%22/><path d=%22M50 10 L18 24 L18 48 C18 68 32 85 50 91 C68 85 82 68 82 48 L82 24 Z%22 fill=%22white%22/></svg>" />
  <title>Start a Transaction ‚Äî TrustBridge</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <script>
/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   TrustBridge Auth System
   Credentials persisted in localStorage.
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

(function () {
  // ‚îÄ‚îÄ STORAGE ‚îÄ‚îÄ
  // tb_users  ‚Üí localStorage only (too large for cookies)
  // tb_session ‚Üí localStorage + cookie backup (tiny, survives browser close)
  function getUsers() {
    try { return JSON.parse(localStorage.getItem('tb_users') || '{}'); } catch { return {}; }
  }
  function saveUsers(u) {
    try { localStorage.setItem('tb_users', JSON.stringify(u)); } catch(e) {
      console.warn('TrustBridge: could not save users to localStorage', e);
    }
  }
  function cookieSet(key, value) {
    try {
      const exp = new Date(Date.now() + 365*24*60*60*1000).toUTCString();
      document.cookie = key + '=' + encodeURIComponent(value) + ';expires=' + exp + ';path=/;SameSite=Lax';
    } catch(e) {}
  }
  function cookieGet(key) {
    try {
      const match = document.cookie.split(';').map(c => c.trim()).find(c => c.startsWith(key + '='));
      return match ? decodeURIComponent(match.substring(key.length + 1)) : null;
    } catch(e) { return null; }
  }
  function cookieDel(key) {
    try { document.cookie = key + '=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;SameSite=Lax'; } catch(e) {}
  }
  function getCurrentUser() {
    try {
      const v = localStorage.getItem('tb_session') || cookieGet('tb_session');
      return v ? JSON.parse(v) : null;
    } catch { return null; }
  }
  function setCurrentUser(u) {
    if (u) {
      const v = JSON.stringify(u);
      try { localStorage.setItem('tb_session', v); } catch(e) {}
      cookieSet('tb_session', v);
    } else {
      try { localStorage.removeItem('tb_session'); } catch(e) {}
      cookieDel('tb_session');
    }
  }

  window.TBAuth = {
    isLoggedIn() { return !!getCurrentUser(); },
    getUser()    { return getCurrentUser(); },

    register(username, password) {
      username = username.trim();
      if (!username || !password) return { ok: false, err: 'Both fields are required.' };
      if (password.length < 6) return { ok: false, err: 'Password must be at least 6 characters.' };
      if (!/^[a-zA-Z0-9_]{3,20}$/.test(username)) return { ok: false, err: 'Username must be 3‚Äì20 characters (letters, numbers, underscores).' };
      const users = getUsers();
      for (const k in users) {
        if (users[k].username.toLowerCase() === username.toLowerCase()) return { ok: false, err: 'Username already taken.' };
      }
      const id = 'u_' + Date.now();
      users[id] = { id, username, password, createdAt: Date.now(), transactions: [] };
      saveUsers(users);
      const user = { id, username };
      setCurrentUser(user);
      return { ok: true, user };
    },

    login(username, password) {
      username = username.trim().toLowerCase();
      if (!username || !password) return { ok: false, err: 'Please enter your credentials.' };
      const users = getUsers();
      let found = null;
      for (const k in users) {
        if (users[k].username.toLowerCase() === username && users[k].password === password) { found = users[k]; break; }
      }
      if (!found) return { ok: false, err: 'Incorrect username or password.' };
      const user = { id: found.id, username: found.username };
      setCurrentUser(user);
      return { ok: true, user };
    },

    logout() { setCurrentUser(null); },

    saveTransaction(txId, txData) {
      const cur = getCurrentUser();
      if (!cur) return;
      const users = getUsers();
      if (!users[cur.id]) return;
      if (!users[cur.id].transactions) users[cur.id].transactions = [];
      const idx = users[cur.id].transactions.findIndex(t => t.id === txId);
      if (idx >= 0) users[cur.id].transactions[idx] = { id: txId, ...txData };
      else users[cur.id].transactions.push({ id: txId, ...txData });
      saveUsers(users);
    },

    getTransactions() {
      const cur = getCurrentUser();
      if (!cur) return [];
      const users = getUsers();
      return users[cur.id]?.transactions || [];
    },

    usernameExists(username) {
      const users = getUsers();
      return Object.values(users).some(u => u.username.toLowerCase() === username.trim().toLowerCase());
    }
  };

  const modalHTML = `
<div id="tb-auth-overlay" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(7,26,53,0.85);backdrop-filter:blur(4px);align-items:center;justify-content:center;padding:1rem;">
  <div style="background:white;border-radius:20px;width:100%;max-width:400px;box-shadow:0 40px 100px rgba(0,0,0,0.4);overflow:hidden;">
    <div style="display:flex;border-bottom:1px solid #e8edf5;">
      <button id="tb-tab-login" onclick="TBAuthUI.showTab('login')" style="flex:1;padding:1.1rem;border:none;background:none;font-family:'DM Sans',sans-serif;font-size:0.92rem;font-weight:700;color:#2477d4;border-bottom:3px solid #2477d4;cursor:pointer;">Sign In</button>
      <button id="tb-tab-register" onclick="TBAuthUI.showTab('register')" style="flex:1;padding:1.1rem;border:none;background:none;font-family:'DM Sans',sans-serif;font-size:0.92rem;font-weight:600;color:#8a99b3;border-bottom:3px solid transparent;cursor:pointer;">Create Account</button>
    </div>
    <div style="padding:2rem 2rem 1.5rem;">
      <div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:1.5rem;">
        <div style="width:34px;height:34px;background:linear-gradient(135deg,#2477d4,#0ea8a8);border-radius:8px;display:flex;align-items:center;justify-content:center;">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="white"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5L12 1zm0 4.9l5 2.23V11c0 3.46-2.38 6.69-5 7.93-2.62-1.24-5-4.47-5-7.93V8.13L12 5.9z"/></svg>
        </div>
        <span style="font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:700;color:#0d2b52;">Trust<span style="color:#0ea8a8;">Bridge</span></span>
      </div>
      <div id="tb-auth-error" style="display:none;background:#fff5f5;border:1px solid #feb2b2;border-radius:8px;padding:0.65rem 1rem;margin-bottom:1rem;font-size:0.83rem;color:#c53030;"></div>
      <div id="tb-form-login">
        <div style="margin-bottom:1rem;">
          <label style="font-size:0.8rem;font-weight:700;color:#4a5568;display:block;margin-bottom:0.4rem;">Enter Username</label>
          <input id="tb-login-username" type="text" placeholder="your_username" autocomplete="username" style="width:100%;padding:0.75rem 1rem;border:1.5px solid #e8edf5;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.9rem;outline:none;transition:border-color 0.2s;" onfocus="this.style.borderColor='#2477d4'" onblur="this.style.borderColor='#e8edf5'">
        </div>
        <div style="margin-bottom:1.4rem;">
          <label style="font-size:0.8rem;font-weight:700;color:#4a5568;display:block;margin-bottom:0.4rem;">Enter Password</label>
          <input id="tb-login-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" style="width:100%;padding:0.75rem 1rem;border:1.5px solid #e8edf5;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.9rem;outline:none;transition:border-color 0.2s;" onfocus="this.style.borderColor='#2477d4'" onblur="this.style.borderColor='#e8edf5'" onkeydown="if(event.key==='Enter')TBAuthUI.submitLogin()">
        </div>
        <button onclick="TBAuthUI.submitLogin()" style="width:100%;padding:0.85rem;background:linear-gradient(135deg,#2477d4,#1a5faa);border:none;border-radius:8px;color:white;font-family:'DM Sans',sans-serif;font-size:0.95rem;font-weight:700;cursor:pointer;box-shadow:0 4px 16px rgba(36,119,212,0.35);" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">Sign In</button>
      </div>
      <div id="tb-form-register" style="display:none;">
        <div style="margin-bottom:1rem;">
          <label style="font-size:0.8rem;font-weight:700;color:#4a5568;display:block;margin-bottom:0.4rem;">Create a Username</label>
          <input id="tb-reg-username" type="text" placeholder="your_username" autocomplete="username" style="width:100%;padding:0.75rem 1rem;border:1.5px solid #e8edf5;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.9rem;outline:none;transition:border-color 0.2s;" onfocus="this.style.borderColor='#2477d4'" onblur="this.style.borderColor='#e8edf5'">
          <div style="font-size:0.73rem;color:#8a99b3;margin-top:0.3rem;">3‚Äì20 characters. Letters, numbers, underscores only.</div>
        </div>
        <div style="margin-bottom:1.4rem;">
          <label style="font-size:0.8rem;font-weight:700;color:#4a5568;display:block;margin-bottom:0.4rem;">Password</label>
          <input id="tb-reg-password" type="password" placeholder="At least 6 characters" autocomplete="new-password" style="width:100%;padding:0.75rem 1rem;border:1.5px solid #e8edf5;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.9rem;outline:none;transition:border-color 0.2s;" onfocus="this.style.borderColor='#2477d4'" onblur="this.style.borderColor='#e8edf5'" onkeydown="if(event.key==='Enter')TBAuthUI.submitRegister()">
        </div>
        <button onclick="TBAuthUI.submitRegister()" style="width:100%;padding:0.85rem;background:linear-gradient(135deg,#2477d4,#1a5faa);border:none;border-radius:8px;color:white;font-family:'DM Sans',sans-serif;font-size:0.95rem;font-weight:700;cursor:pointer;box-shadow:0 4px 16px rgba(36,119,212,0.35);" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">Create Account</button>
      </div>
      <button onclick="TBAuthUI.closeModal()" style="width:100%;margin-top:0.9rem;padding:0.6rem;background:none;border:none;color:#8a99b3;font-family:'DM Sans',sans-serif;font-size:0.83rem;cursor:pointer;">Cancel</button>
    </div>
  </div>
</div>`;

  window.TBAuthUI = {
    _requireAuth: false,
    _onLogin: null,

    init(options = {}) {
      if (!document.getElementById('tb-auth-overlay')) {
        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }
      this._requireAuth = options.requireAuth || false;
      this._onLogin     = options.onLogin || null;
      this.renderNavButton();
      // Only show modal if requireAuth AND not already logged in
      if (this._requireAuth && !TBAuth.isLoggedIn()) {
        this.openModal('login');
      }
    },

    renderNavButton() {
      const container = document.getElementById('tb-nav-auth');
      if (!container) return;
      const user = TBAuth.getUser();
      if (user) {
        container.innerHTML = `<span style="font-size:0.82rem;color:rgba(255,255,255,0.65);font-weight:500;">Hi, <strong style="color:white;">${escHtml(user.username)}</strong></span>
          <button onclick="TBAuthUI.logout()" style="padding:0.45rem 1.1rem;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:rgba(255,255,255,0.85);font-family:'DM Sans',sans-serif;font-size:0.83rem;font-weight:600;cursor:pointer;" onmouseover="this.style.background='rgba(255,255,255,0.15)'" onmouseout="this.style.background='rgba(255,255,255,0.08)'">Sign Out</button>`;
      } else {
        container.innerHTML = `<button onclick="TBAuthUI.openModal('login')" style="padding:0.45rem 1.1rem;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:rgba(255,255,255,0.85);font-family:'DM Sans',sans-serif;font-size:0.83rem;font-weight:600;cursor:pointer;" onmouseover="this.style.background='rgba(255,255,255,0.15)'" onmouseout="this.style.background='rgba(255,255,255,0.08)'">Sign In</button>
          <button onclick="TBAuthUI.openModal('register')" style="padding:0.45rem 1.1rem;background:linear-gradient(135deg,#2477d4,#1a5faa);border:none;border-radius:6px;color:white;font-family:'DM Sans',sans-serif;font-size:0.83rem;font-weight:600;cursor:pointer;box-shadow:0 2px 10px rgba(36,119,212,0.4);" onmouseover="this.style.opacity='0.88'" onmouseout="this.style.opacity='1'">Create Account</button>`;
      }
    },

    openModal(tab = 'login') {
      const overlay = document.getElementById('tb-auth-overlay');
      overlay.style.display = 'flex';
      this.showTab(tab);
      this.clearError();
      document.body.style.overflow = 'hidden';
      overlay.onclick = (e) => { if (e.target === overlay && !this._requireAuth) this.closeModal(); };
    },

    closeModal() {
      document.getElementById('tb-auth-overlay').style.display = 'none';
      document.body.style.overflow = '';
    },

    showTab(tab) {
      const lf = document.getElementById('tb-form-login');
      const rf = document.getElementById('tb-form-register');
      const tl = document.getElementById('tb-tab-login');
      const tr = document.getElementById('tb-tab-register');
      this.clearError();
      if (tab === 'login') {
        lf.style.display = 'block'; rf.style.display = 'none';
        tl.style.color = '#2477d4'; tl.style.borderBottomColor = '#2477d4'; tl.style.fontWeight = '700';
        tr.style.color = '#8a99b3'; tr.style.borderBottomColor = 'transparent'; tr.style.fontWeight = '600';
      } else {
        lf.style.display = 'none'; rf.style.display = 'block';
        tr.style.color = '#2477d4'; tr.style.borderBottomColor = '#2477d4'; tr.style.fontWeight = '700';
        tl.style.color = '#8a99b3'; tl.style.borderBottomColor = 'transparent'; tl.style.fontWeight = '600';
      }
    },

    showError(msg) {
      const el = document.getElementById('tb-auth-error');
      el.textContent = msg; el.style.display = 'block';
    },

    clearError() {
      const el = document.getElementById('tb-auth-error');
      if (el) { el.textContent = ''; el.style.display = 'none'; }
    },

    submitLogin() {
      const username = document.getElementById('tb-login-username').value;
      const password = document.getElementById('tb-login-password').value;
      const result = TBAuth.login(username, password);
      if (!result.ok) { this.showError(result.err); return; }
      this.closeModal();
      this.renderNavButton();
      if (this._onLogin) this._onLogin(result.user);
    },

    submitRegister() {
      const username = document.getElementById('tb-reg-username').value;
      const password = document.getElementById('tb-reg-password').value;
      const result = TBAuth.register(username, password);
      if (!result.ok) { this.showError(result.err); return; }
      this.closeModal();
      this.renderNavButton();
      if (this._onLogin) this._onLogin(result.user);
    },

    logout() {
      TBAuth.logout();
      this.renderNavButton();
      if (this._requireAuth) window.location.href = 'index.html';
    }
  };

  function escHtml(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }
})();

</script>
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --navy: #0d2b52;
      --navy-deep: #071a35;
      --navy-mid: #163a6e;
      --blue: #1a5faa;
      --blue-bright: #2477d4;
      --teal: #0ea8a8;
      --white: #ffffff;
      --off-white: #f4f7fb;
      --light-gray: #e8edf5;
      --text-dark: #0d1f3c;
      --text-mid: #4a5568;
      --text-light: #8a99b3;
      --gold: #c99a2e;
      --green: #27a85e;
      --red: #e53e3e;
    }
    html { scroll-behavior: smooth; }
    @keyframes timerPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    body {
      font-family: 'DM Sans', sans-serif;
      color: var(--text-dark);
      background: var(--off-white);
      min-height: 100vh;
    }

    /* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
    nav {
      position: fixed; top: 0; left: 0; right: 0;
      z-index: 1000;
      background: var(--navy-deep);
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .nav-inner {
      max-width: 1200px; margin: 0 auto;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 2rem; height: 68px;
    }
    .logo { display: flex; align-items: center; gap: 10px; text-decoration: none; }
    .logo-icon {
      width: 36px; height: 36px;
      background: linear-gradient(135deg, var(--blue-bright), var(--teal));
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
    }
    .logo-icon svg { width: 20px; height: 20px; fill: white; }
    .logo-text {
      font-family: 'Playfair Display', serif;
      font-size: 1.4rem; font-weight: 700; color: var(--white);
    }
    .logo-text span { color: var(--teal); }
    .nav-right { display: flex; align-items: center; gap: 1rem; }
    .nav-link {
      font-size: 0.85rem; color: rgba(255,255,255,0.6);
      text-decoration: none; transition: color 0.2s;
    }
    .nav-link:hover { color: white; }

    /* ‚îÄ‚îÄ PAGE LAYOUT ‚îÄ‚îÄ */
    .page-wrap {
      padding-top: 68px;
      min-height: 100vh;
      display: flex; flex-direction: column;
    }

    /* ‚îÄ‚îÄ PROGRESS HEADER ‚îÄ‚îÄ */
    .progress-header {
      background: white;
      border-bottom: 1px solid var(--light-gray);
      padding: 0;
    }
    .progress-header-inner {
      max-width: 860px; margin: 0 auto; padding: 0 2rem;
    }
    .steps-bar {
      display: flex; align-items: stretch;
      gap: 0;
    }
    .step-tab {
      flex: 1;
      display: flex; align-items: center; gap: 12px;
      padding: 1.1rem 0;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      transition: all 0.25s;
      padding-right: 1.5rem;
    }
    .step-tab + .step-tab { padding-left: 1.5rem; border-left: 1px solid var(--light-gray); }
    .step-tab.active { border-bottom-color: var(--blue-bright); }
    .step-tab.done { border-bottom-color: var(--green); }
    .step-tab.locked { opacity: 0.4; cursor: not-allowed; }
    .step-bubble {
      width: 30px; height: 30px; border-radius: 50%; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.78rem; font-weight: 700;
      background: var(--light-gray); color: var(--text-mid);
      transition: all 0.25s;
    }
    .step-tab.active .step-bubble { background: var(--blue-bright); color: white; }
    .step-tab.done .step-bubble { background: var(--green); color: white; }
    .step-tab-label { font-size: 0.82rem; font-weight: 600; color: var(--text-mid); transition: color 0.25s; }
    .step-tab.active .step-tab-label { color: var(--navy); }
    .step-tab.done .step-tab-label { color: var(--green); }
    .step-tab-sub { font-size: 0.73rem; color: var(--text-light); font-weight: 400; }

    /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
    .main {
      flex: 1;
      max-width: 860px; margin: 0 auto;
      padding: 2.5rem 2rem 4rem;
      width: 100%;
    }

    /* ‚îÄ‚îÄ STEP PANELS ‚îÄ‚îÄ */
    .step-panel { display: none; }
    .step-panel.active { display: block; }

    .panel-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.7rem; font-weight: 700;
      color: var(--navy); margin-bottom: 0.4rem;
    }
    .panel-sub {
      font-size: 0.9rem; color: var(--text-mid);
      margin-bottom: 2rem; line-height: 1.6;
    }

    /* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
    .card {
      background: white;
      border: 1px solid var(--light-gray);
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 1.5rem;
    }
    .card-title {
      font-size: 0.95rem; font-weight: 700;
      color: var(--navy); margin-bottom: 1.2rem;
      display: flex; align-items: center; gap: 8px;
    }
    .card-title-icon {
      width: 28px; height: 28px; border-radius: 7px;
      background: rgba(26,95,170,0.1);
      display: flex; align-items: center; justify-content: center;
      font-size: 0.85rem;
    }

    /* ‚îÄ‚îÄ CATEGORY GRID (Step 1) ‚îÄ‚îÄ */
    .category-grid {
      display: grid; grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
    }
    .cat-option {
      border: 2px solid var(--light-gray);
      border-radius: 12px;
      padding: 1.2rem 1rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--off-white);
    }
    .cat-option:hover { border-color: var(--blue-bright); background: rgba(36,119,212,0.04); }
    .cat-option.selected { border-color: var(--blue-bright); background: rgba(36,119,212,0.07); box-shadow: 0 0 0 3px rgba(36,119,212,0.12); }
    .cat-option-icon { font-size: 1.8rem; margin-bottom: 0.5rem; pointer-events: none; }
    .cat-option-label { font-size: 0.8rem; font-weight: 600; color: var(--navy); pointer-events: none; }

    /* ‚îÄ‚îÄ FORM ELEMENTS ‚îÄ‚îÄ */
    .form-row { display: grid; gap: 1rem; margin-bottom: 1.2rem; }
    .form-row.cols-2 { grid-template-columns: 1fr 1fr; }
    .form-row.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
    .form-group { display: flex; flex-direction: column; gap: 6px; }
    label { font-size: 0.82rem; font-weight: 600; color: var(--navy); }
    label .optional { font-weight: 400; color: var(--text-light); font-size: 0.75rem; }
    input[type="text"],
    input[type="email"],
    input[type="number"],
    input[type="tel"],
    select, textarea {
      width: 100%; padding: 0.7rem 0.9rem;
      border: 1.5px solid var(--light-gray);
      border-radius: 8px;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.9rem; color: var(--text-dark);
      background: white;
      transition: border-color 0.2s, box-shadow 0.2s;
      outline: none;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--blue-bright);
      box-shadow: 0 0 0 3px rgba(36,119,212,0.1);
    }
    input.error, select.error { border-color: var(--red); }
    .field-error { font-size: 0.75rem; color: var(--red); margin-top: 2px; display: none; }
    .field-error.show { display: block; }
    textarea { resize: vertical; min-height: 90px; }
    .input-prefix-wrap { position: relative; }
    .input-prefix { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); font-size: 0.9rem; font-weight: 600; color: var(--text-mid); pointer-events: none; }
    .input-prefix-wrap input { padding-left: 1.8rem; }

    /* ‚îÄ‚îÄ ROLE SELECTOR ‚îÄ‚îÄ */
    .role-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .role-card { border: 2px solid var(--light-gray); border-radius: 12px; padding: 1.4rem; cursor: pointer; transition: all 0.2s; background: var(--off-white); }
    .role-card:hover { border-color: var(--blue-bright); }
    .role-card.selected { border-color: var(--blue-bright); background: rgba(36,119,212,0.05); }
    .role-card-icon { font-size: 1.5rem; margin-bottom: 0.5rem; }
    .role-card-title { font-size: 0.92rem; font-weight: 700; color: var(--navy); margin-bottom: 0.3rem; }
    .role-card-desc { font-size: 0.78rem; color: var(--text-mid); line-height: 1.5; }
    .role-radio { display: none; }

    /* ‚îÄ‚îÄ CURRENCY ROW ‚îÄ‚îÄ */
    .currency-prefix { display: flex; gap: 0; }
    .currency-prefix select { width: 90px; border-radius: 8px 0 0 8px; border-right: none; flex-shrink: 0; }
    .currency-prefix input { border-radius: 0 8px 8px 0; flex: 1; }

    /* ‚îÄ‚îÄ INSPECTION PERIOD ‚îÄ‚îÄ */
    .inspection-options { display: flex; gap: 0.7rem; flex-wrap: wrap; }
    .inspection-pill {
      padding: 0.5rem 1rem;
      border: 2px solid var(--light-gray);
      border-radius: 50px;
      font-size: 0.82rem; font-weight: 600;
      color: var(--text-mid);
      cursor: pointer; transition: all 0.2s;
      background: white;
    }
    .inspection-pill:hover { border-color: var(--blue-bright); color: var(--blue-bright); }
    .inspection-pill.selected { border-color: var(--blue-bright); background: var(--blue-bright); color: white; }

    /* ‚îÄ‚îÄ FEE SUMMARY CARD ‚îÄ‚îÄ */
    .fee-summary {
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-mid) 100%);
      border-radius: 16px; padding: 1.8rem;
      color: white; margin-bottom: 1.5rem;
    }
    .fee-summary-title { font-size: 0.78rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: rgba(255,255,255,0.5); margin-bottom: 1.2rem; }
    .fee-row { display: flex; justify-content: space-between; align-items: center; padding: 0.55rem 0; border-bottom: 1px solid rgba(255,255,255,0.08); font-size: 0.87rem; }
    .fee-row:last-child { border-bottom: none; }
    .fee-label { color: rgba(255,255,255,0.65); }
    .fee-value { font-weight: 600; color: white; }
    .fee-value.teal { color: var(--teal); }
    .fee-total-row { display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; margin-top: 0.5rem; }
    .fee-total-label { font-size: 0.85rem; color: rgba(255,255,255,0.5); }
    .fee-total-value { font-family: 'Playfair Display', serif; font-size: 1.6rem; font-weight: 700; color: white; }
    .fee-note { font-size: 0.75rem; color: rgba(255,255,255,0.35); margin-top: 0.7rem; line-height: 1.5; }

    /* ‚îÄ‚îÄ WHO PAYS FEE ‚îÄ‚îÄ */
    .fee-split-options { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.8rem; }
    .fee-split-card { border: 2px solid var(--light-gray); border-radius: 10px; padding: 1rem; text-align: center; cursor: pointer; transition: all 0.2s; background: white; }
    .fee-split-card:hover { border-color: var(--blue-bright); }
    .fee-split-card.selected { border-color: var(--blue-bright); background: rgba(36,119,212,0.05); }
    .fee-split-title { font-size: 0.82rem; font-weight: 700; color: var(--navy); margin-bottom: 0.3rem; }
    .fee-split-desc { font-size: 0.72rem; color: var(--text-mid); }

    /* ‚îÄ‚îÄ REVIEW SECTION (Step 4) ‚îÄ‚îÄ */
    .review-grid { display: flex; flex-direction: column; gap: 0; }
    .review-item { display: flex; justify-content: space-between; align-items: flex-start; padding: 0.9rem 0; border-bottom: 1px solid var(--light-gray); }
    .review-item:last-child { border-bottom: none; }
    .review-key { font-size: 0.82rem; color: var(--text-mid); font-weight: 500; }
    .review-val { font-size: 0.88rem; color: var(--navy); font-weight: 600; text-align: right; max-width: 60%; }
    .review-edit { font-size: 0.75rem; color: var(--blue-bright); cursor: pointer; text-decoration: underline; margin-left: 8px; white-space: nowrap; }

    /* ‚îÄ‚îÄ AGREEMENT ‚îÄ‚îÄ */
    .agreement-box {
      background: var(--off-white);
      border: 1px solid var(--light-gray);
      border-radius: 12px; padding: 1.5rem;
      max-height: 180px; overflow-y: auto;
      font-size: 0.8rem; color: var(--text-mid);
      line-height: 1.7; margin-bottom: 1.2rem;
    }
    .agreement-box h4 { color: var(--navy); margin-bottom: 0.5rem; font-size: 0.85rem; }
    .checkbox-row { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 1rem; }
    .checkbox-row input[type="checkbox"] { width: 18px; height: 18px; flex-shrink: 0; margin-top: 2px; accent-color: var(--blue-bright); }
    .checkbox-row label { font-size: 0.85rem; color: var(--text-mid); line-height: 1.5; cursor: pointer; }
    .checkbox-row label a { color: var(--blue-bright); }

    /* ‚îÄ‚îÄ SUCCESS PANEL (Step 5) ‚îÄ‚îÄ */
    .success-panel { text-align: center; padding: 3rem 2rem; }
    .success-icon {
      width: 80px; height: 80px;
      background: linear-gradient(135deg, var(--green), #36c772);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 2rem; margin: 0 auto 1.5rem;
      box-shadow: 0 8px 32px rgba(39,168,94,0.3);
      animation: pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes pop { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    .success-title { font-family: 'Playfair Display', serif; font-size: 2rem; font-weight: 700; color: var(--navy); margin-bottom: 0.5rem; }
    .success-sub { font-size: 1rem; color: var(--text-mid); line-height: 1.7; max-width: 480px; margin: 0 auto 2rem; }
    .tx-id-box {
      display: inline-flex; align-items: center; gap: 10px;
      background: var(--off-white);
      border: 1px solid var(--light-gray);
      border-radius: 10px; padding: 0.8rem 1.5rem;
      margin-bottom: 2rem;
    }
    .tx-id-label { font-size: 0.8rem; color: var(--text-mid); }
    .tx-id-value { font-size: 1rem; font-weight: 700; color: var(--navy); font-family: monospace; }
    .copy-btn { font-size: 0.75rem; color: var(--blue-bright); cursor: pointer; padding: 4px 8px; border: 1px solid rgba(36,119,212,0.3); border-radius: 6px; transition: all 0.2s; }
    .copy-btn:hover { background: rgba(36,119,212,0.08); }
    .success-actions { display: flex; gap: 1rem; justify-content: center; }

    /* ‚îÄ‚îÄ NAVIGATION BUTTONS ‚îÄ‚îÄ */
    .nav-buttons { display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; }
    .btn-back { padding: 0.8rem 1.8rem; background: transparent; border: 1.5px solid var(--light-gray); border-radius: 8px; color: var(--text-mid); font-size: 0.92rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; }
    .btn-back:hover { border-color: var(--text-mid); color: var(--text-dark); }
    .btn-next { padding: 0.85rem 2.2rem; background: linear-gradient(135deg, var(--blue-bright), var(--blue)); border: none; border-radius: 8px; color: white; font-size: 0.95rem; font-weight: 700; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 20px rgba(36,119,212,0.35); }
    .btn-next:hover { transform: translateY(-1px); box-shadow: 0 8px 28px rgba(36,119,212,0.45); }
    .btn-submit { padding: 0.85rem 2.2rem; background: linear-gradient(135deg, var(--green), #1d9050); border: none; border-radius: 8px; color: white; font-size: 0.95rem; font-weight: 700; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 20px rgba(39,168,94,0.35); display: flex; align-items: center; gap: 8px; }
    .btn-submit:hover { transform: translateY(-1px); box-shadow: 0 8px 28px rgba(39,168,94,0.45); }
    .btn-primary-full { padding: 0.85rem 2rem; background: linear-gradient(135deg, var(--blue-bright), var(--blue)); border: none; border-radius: 8px; color: white; font-size: 0.92rem; font-weight: 700; cursor: pointer; transition: all 0.2s; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 4px 20px rgba(36,119,212,0.3); }
    .btn-primary-full:hover { transform: translateY(-1px); }
    .btn-outline { padding: 0.85rem 2rem; background: transparent; border: 1.5px solid var(--light-gray); border-radius: 8px; color: var(--text-mid); font-size: 0.92rem; font-weight: 600; cursor: pointer; transition: all 0.2s; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; }
    .btn-outline:hover { border-color: var(--navy); color: var(--navy); }

    /* ‚îÄ‚îÄ INFO BADGE ‚îÄ‚îÄ */
    .info-badge { display: flex; align-items: flex-start; gap: 10px; background: rgba(36,119,212,0.06); border: 1px solid rgba(36,119,212,0.15); border-radius: 10px; padding: 1rem; margin-bottom: 1.2rem; }
    .info-badge-icon { font-size: 1rem; flex-shrink: 0; margin-top: 1px; }
    .info-badge p { font-size: 0.82rem; color: var(--text-mid); line-height: 1.6; }
    .info-badge strong { color: var(--navy); }

    /* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
    .section-divider { border: none; border-top: 1px solid var(--light-gray); margin: 1.5rem 0; }
    .helper-text { font-size: 0.77rem; color: var(--text-light); margin-top: 4px; line-height: 1.5; }

    @media (max-width: 700px) {
      .category-grid { grid-template-columns: repeat(2, 1fr); }
      .form-row.cols-2, .form-row.cols-3 { grid-template-columns: 1fr; }
      .role-selector { grid-template-columns: 1fr; }
      .fee-split-options { grid-template-columns: 1fr; }
      .steps-bar { overflow-x: auto; }
      .step-tab-sub { display: none; }
    }
  </style>
</head>
<body>

<!-- NAV -->
<nav>
  <div class="nav-inner">
    <a href="index.html" class="logo">
      <div class="logo-icon">
        <svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5L12 1zm0 4.9l5 2.23V11c0 3.46-2.38 6.69-5 7.93-2.62-1.24-5-4.47-5-7.93V8.13L12 5.9z"/></svg>
      </div>
      <span class="logo-text">Trust<span>Bridge</span></span>
    </a>
    <div class="nav-right">
      <div id="tb-nav-auth" style="display:flex;align-items:center;gap:0.7rem;"></div>
      <a href="index.html" class="nav-link">‚Üê Back to Home</a>
    </div>
  </div>
</nav>

<!-- PROGRESS BAR -->
<div class="page-wrap">
  <div class="progress-header">
    <div class="progress-header-inner">
      <div class="steps-bar">
        <div class="step-tab active" data-step="1" onclick="goToStep(1)">
          <div class="step-bubble">1</div>
          <div>
            <div class="step-tab-label">Transaction Type</div>
            <div class="step-tab-sub">What are you transacting?</div>
          </div>
        </div>
        <div class="step-tab locked" data-step="2" onclick="goToStep(2)">
          <div class="step-bubble">2</div>
          <div>
            <div class="step-tab-label">Details</div>
            <div class="step-tab-sub">Amount & description</div>
          </div>
        </div>
        <div class="step-tab locked" data-step="3" onclick="goToStep(3)">
          <div class="step-bubble">3</div>
          <div>
            <div class="step-tab-label">Party Details</div>
            <div class="step-tab-sub">Your info & role</div>
          </div>
        </div>
        <div class="step-tab locked" data-step="4" onclick="goToStep(4)">
          <div class="step-bubble">4</div>
          <div>
            <div class="step-tab-label">Review & Submit</div>
            <div class="step-tab-sub">Confirm everything</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main">

    <!-- ‚ïê‚ïê‚ïê STEP 1: TRANSACTION TYPE ‚ïê‚ïê‚ïê -->
    <div class="step-panel active" id="panel-1">
      <h1 class="panel-title">What are you transacting?</h1>
      <p class="panel-sub">Select the category that best describes your transaction. This helps us apply the right protections and terms.</p>

      <div class="card">
        <div class="card-title">
          <div class="card-title-icon">üè∑Ô∏è</div>
          Select a Transaction Category
        </div>
        <div class="category-grid" id="categoryGrid">
          <div class="cat-option" data-value="domain">
            <div class="cat-option-icon">üåê</div>
            <div class="cat-option-label">Domain Name</div>
          </div>
          <div class="cat-option" data-value="real-estate">
            <div class="cat-option-icon">üè†</div>
            <div class="cat-option-label">Real Estate</div>
          </div>
          <div class="cat-option" data-value="vehicle">
            <div class="cat-option-icon">üöó</div>
            <div class="cat-option-label">Motor Vehicle</div>
          </div>
          <div class="cat-option" data-value="tech">
            <div class="cat-option-icon">üíª</div>
            <div class="cat-option-label">Tech / Software</div>
          </div>
          <div class="cat-option" data-value="luxury">
            <div class="cat-option-icon">üíé</div>
            <div class="cat-option-label">Luxury Goods</div>
          </div>
          <div class="cat-option" data-value="business">
            <div class="cat-option-icon">üè¢</div>
            <div class="cat-option-label">Business Sale</div>
          </div>
          <div class="cat-option" data-value="digital">
            <div class="cat-option-icon">üé®</div>
            <div class="cat-option-label">Digital Assets</div>
          </div>
          <div class="cat-option" data-value="services">
            <div class="cat-option-icon">üîß</div>
            <div class="cat-option-label">Services</div>
          </div>
        </div>
        <p id="cat-error" class="field-error" style="margin-top:10px;">Please select a transaction category.</p>
      </div>

      <div class="info-badge">
        <span class="info-badge-icon">‚ÑπÔ∏è</span>
        <p>Not sure which category fits? <strong>General Merchandise</strong> covers most physical goods. You can add notes in the details step. Our team reviews all transactions before funds are collected.</p>
      </div>

      <div class="nav-buttons">
        <div></div>
        <button class="btn-next" onclick="nextStep(1)">
          Continue <span>‚Üí</span>
        </button>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê STEP 2: TRANSACTION DETAILS ‚ïê‚ïê‚ïê -->
    <div class="step-panel" id="panel-2">
      <h1 class="panel-title">Transaction Details</h1>
      <p class="panel-sub">Tell us about the specifics of the deal ‚Äî the amount, what's being transacted, and how long the inspection period will be.</p>

      <div class="card">
        <div class="card-title">
          <div class="card-title-icon">üí∞</div>
          Amount & Currency
        </div>
        <div class="form-row cols-2">
          <div class="form-group">
            <label>Transaction Amount</label>
            <div class="currency-prefix">
              <select id="currency">
                <option value="USD">USD $</option>
                <option value="CAD">CAD $</option>
                <option value="GBP">GBP ¬£</option>
                <option value="EUR">EUR ‚Ç¨</option>
                <option value="AUD">AUD $</option>
              </select>
              <input type="number" id="amount" placeholder="0.00" min="1" step="0.01" oninput="updateFee()" />
            </div>
            <span class="field-error" id="amount-error">Please enter a valid transaction amount.</span>
          </div>
          <div class="form-group">
            <label>Payment Method</label>
            <select id="payment-method">
              <option value="">Select payment method...</option>
              <option value="wire">Wire Transfer</option>
              <option value="ach">ACH / Bank Transfer</option>
              <option value="card">Credit / Debit Card</option>
              <option value="crypto">Cryptocurrency</option>
            </select>
            <span class="field-error" id="payment-error">Please select a payment method.</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">
          <div class="card-title-icon">üìù</div>
          Description
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Transaction Title</label>
            <input type="text" id="tx-title" placeholder="e.g. Sale of premium-domain.com" />
            <span class="field-error" id="title-error">Please enter a transaction title.</span>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Description <span class="optional">(optional but recommended)</span></label>
            <textarea id="tx-desc" placeholder="Describe what is being bought or sold, any important conditions, delivery method, etc."></textarea>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">
          <div class="card-title-icon">üîç</div>
          Inspection Period
        </div>
        <p style="font-size:0.82rem; color:var(--text-mid); margin-bottom:1rem; line-height:1.6;">
          After the seller delivers, how many days does the buyer have to inspect before TrustBridge releases funds?
        </p>
        <div class="inspection-options" id="inspectionOptions">
          <div class="inspection-pill" data-value="1" onclick="selectInspection(this)">1 Day</div>
          <div class="inspection-pill selected" data-value="3" onclick="selectInspection(this)">3 Days</div>
          <div class="inspection-pill" data-value="5" onclick="selectInspection(this)">5 Days</div>
          <div class="inspection-pill" data-value="7" onclick="selectInspection(this)">7 Days</div>
          <div class="inspection-pill" data-value="14" onclick="selectInspection(this)">14 Days</div>
          <div class="inspection-pill" data-value="30" onclick="selectInspection(this)">30 Days</div>
        </div>
      </div>

      <!-- Fee Preview -->
      <div class="fee-summary" id="feeSummary">
        <div class="fee-summary-title">Estimated Fee Breakdown</div>
        <div class="fee-row">
          <span class="fee-label">Transaction Amount</span>
          <span class="fee-value" id="fee-amount-display">$0.00</span>
        </div>
        <div class="fee-row">
          <span class="fee-label">TrustBridge Escrow Fee</span>
          <span class="fee-value teal" id="fee-escrow-display">$250.00</span>
        </div>
        <div class="fee-row">
          <span class="fee-label">Payment Processing Fee</span>
          <span class="fee-value" id="fee-processing-display">$0.00</span>
        </div>
        <div class="fee-total-row">
          <span class="fee-total-label">Total Buyer Pays</span>
          <span class="fee-total-value" id="fee-total-display">$250.00</span>
        </div>
        <p class="fee-note">* Flat $250 escrow fee applies to all transactions, regardless of size. Final fees confirmed before payment.</p>
      </div>

      <div class="card">
        <div class="card-title">
          <div class="card-title-icon">‚öñÔ∏è</div>
          Who Pays the Escrow Fee?
        </div>
        <div class="fee-split-options">
          <div class="fee-split-card selected" data-value="buyer" onclick="selectFeePayer(this)">
            <div class="fee-split-title">Buyer Pays</div>
            <div class="fee-split-desc">The buyer covers all escrow fees on top of the transaction amount.</div>
          </div>
          <div class="fee-split-card" data-value="seller" onclick="selectFeePayer(this)">
            <div class="fee-split-title">Seller Pays</div>
            <div class="fee-split-desc">The fee is deducted from the amount paid out to the seller.</div>
          </div>
          <div class="fee-split-card" data-value="split" onclick="selectFeePayer(this)">
            <div class="fee-split-title">Split 50/50</div>
            <div class="fee-split-desc">Both parties share the escrow fee equally.</div>
          </div>
        </div>
      </div>

      <div class="nav-buttons">
        <button class="btn-back" onclick="prevStep(2)">‚Üê Back</button>
        <button class="btn-next" onclick="nextStep(2)">Continue ‚Üí</button>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê STEP 3: YOUR DETAILS ‚ïê‚ïê‚ïê -->
    <div class="step-panel" id="panel-3">
      <h1 class="panel-title">Party Details</h1>
      <p class="panel-sub">Tell us your role, enter your information, invite the other party, and choose a trusted middle-man to host your transaction.</p>

      <div class="card">
        <div class="card-title">
          <div class="card-title-icon">üë§</div>
          Your Role in this Transaction
        </div>
        <div class="role-selector">
          <div class="role-card selected" data-value="buyer" onclick="selectRole(this)">
            <input type="radio" name="role" class="role-radio" value="buyer" checked />
            <div class="role-card-icon">üõí</div>
            <div class="role-card-title">I am the Buyer</div>
            <div class="role-card-desc">I will be sending funds into escrow and receiving goods or services.</div>
          </div>
          <div class="role-card" data-value="seller" onclick="selectRole(this)">
            <input type="radio" name="role" class="role-radio" value="seller" />
            <div class="role-card-icon">üì¶</div>
            <div class="role-card-title">I am the Seller</div>
            <div class="role-card-desc">I will be delivering goods or services and receiving funds from escrow.</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">
          <div class="card-title-icon">üìã</div>
          Party Details
        </div>
        <div class="form-row cols-2">
          <div class="form-group">
            <label>First Name</label>
            <input type="text" id="my-first" placeholder="John" />
            <span class="field-error" id="my-first-error">Required.</span>
          </div>
          <div class="form-group">
            <label>Last Name</label>
            <input type="text" id="my-last" placeholder="Smith" />
            <span class="field-error" id="my-last-error">Required.</span>
          </div>
        </div>
        <div class="form-row cols-2">
          <div class="form-group">
            <label>Phone Number <span class="optional">(optional)</span></label>
            <input type="tel" id="my-phone" placeholder="+1 (555) 000-0000" />
          </div>
          <div class="form-group">
            <label>Country</label>
            <select id="my-country">
              <option value="">Select country...</option>
              <option value="US">United States</option>
              <option value="CA">Canada</option>
              <option value="GB">United Kingdom</option>
              <option value="AU">Australia</option>
              <option value="DE">Germany</option>
              <option value="FR">France</option>
              <option value="other">Other</option>
            </select>
          </div>
        </div>
        <div class="form-row cols-2">
          <div class="form-group">
            <label>Account Type</label>
            <select id="my-account-type">
              <option value="individual">Individual</option>
              <option value="business">Business / Company</option>
            </select>
          </div>
          <div class="form-group" id="company-row" style="display:none;">
            <label>Company Name</label>
            <input type="text" id="my-company" placeholder="Acme Corp Ltd." />
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">
          <div class="card-title-icon">ü§ù</div>
          Invite the Other Party
        </div>
        <p style="font-size:0.88rem;color:var(--text-mid);margin-bottom:1.2rem;line-height:1.6;">Enter the TrustBridge username of the buyer or seller you're transacting with. They'll be linked to this transaction once it's created.</p>
        <div class="form-group">
          <label>Their TrustBridge Username</label>
          <input type="text" id="counterparty-username" placeholder="e.g. johndoe_99" />
          <span class="field-error" id="counterparty-error">Please enter the other party's username.</span>
          <div id="counterparty-status" style="margin-top:0.4rem;font-size:0.8rem;"></div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ MIDDLE-MAN SELECTOR ‚îÄ‚îÄ -->
      <div class="card">
        <div class="card-title">
          <div class="card-title-icon">üõ°Ô∏è</div>
          Choose Middle-Man to Host
        </div>
        <p style="font-size:0.88rem;color:var(--text-mid);margin-bottom:1.2rem;line-height:1.6;">Select a verified TrustBridge middle-man to oversee and host your transaction. All middle-men are identity-verified and trained in dispute resolution.</p>
        <div class="form-group" style="margin-bottom:0;">
          <label>Select a Verified Middle-Man</label>
          <div style="position:relative;">
            <!-- Hidden native select for form value only -->
            <select id="middleman-select" style="display:none;" onchange="updateMiddlemanPreview(this)">
              <option value="">‚Äî Select a middle-man ‚Äî</option>
              <option value="Cold">Cold</option>
              <option value="Fame">Fame</option>
              <option value="Tall">Tall</option>
              <option value="Grin">Grin</option>
              <option value="Poor">Poor</option>
              <option value="Hand">Hand</option>
              <option value="Poem">Poem</option>
              <option value="Wine">Wine</option>
              <option value="Torn">Torn</option>
              <option value="Underground">Underground</option>
            </select>

            <!-- Custom dropdown UI -->
            <div id="mm-dropdown-wrap" style="position:relative;user-select:none;">
              <div id="mm-trigger" onclick="toggleMmDropdown()" style="
                display:flex;align-items:center;justify-content:space-between;
                width:100%;padding:0.85rem 1rem;
                border:1.5px solid var(--light-gray);border-radius:10px;
                font-family:'DM Sans',sans-serif;font-size:0.95rem;
                color:var(--text-light);background:white;cursor:pointer;
                transition:border-color 0.2s,box-shadow 0.2s;
              ">
                <span id="mm-trigger-label">‚Äî Select a middle-man ‚Äî</span>
                <svg id="mm-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="color:var(--text-light);flex-shrink:0;transition:transform 0.2s;"><polyline points="6 9 12 15 18 9"></polyline></svg>
              </div>
              <div id="mm-list" style="
                display:none;position:absolute;top:calc(100% + 6px);left:0;right:0;
                background:white;border:1.5px solid var(--light-gray);border-radius:10px;
                box-shadow:0 8px 32px rgba(13,43,82,0.12);z-index:200;overflow:hidden;
              "></div>
            </div>
          </div>

          <!-- Preview card shown after selection -->
          <div id="middleman-preview" style="
            display:none;
            margin-top:1rem;
            background:linear-gradient(135deg, rgba(36,119,212,0.06), rgba(14,168,168,0.06));
            border:1.5px solid rgba(36,119,212,0.2);
            border-radius:10px;
            padding:0.9rem 1.1rem;
            display:none;
            align-items:center;
            gap:12px;
          ">
            <div style="
              width:42px;height:42px;flex-shrink:0;
              background:linear-gradient(135deg,var(--blue-bright),var(--teal));
              border-radius:50%;
              display:flex;align-items:center;justify-content:center;
              font-size:1.1rem;font-weight:700;color:white;
              font-family:'Playfair Display',serif;
            " id="middleman-avatar">‚Äî</div>
            <div style="flex:1;">
              <div style="display:flex;align-items:center;gap:6px;">
                <span style="font-size:0.95rem;font-weight:700;color:var(--navy);" id="middleman-name">‚Äî</span>
                <span style="
                  display:inline-flex;align-items:center;gap:3px;
                  background:rgba(14,168,168,0.12);
                  border:1px solid rgba(14,168,168,0.3);
                  border-radius:50px;
                  padding:2px 8px;
                  font-size:0.68rem;font-weight:700;color:var(--teal);
                  text-transform:uppercase;letter-spacing:0.06em;
                ">‚úî Verified</span>
              </div>
              <div style="font-size:0.78rem;color:var(--text-light);margin-top:2px;">TrustBridge Certified Middle-Man ¬∑ Identity Verified</div>
            </div>
          </div>
          <span class="field-error" id="middleman-error">Please select a middle-man to host your transaction.</span>
        </div>
      </div>

      <div class="nav-buttons">
        <button class="btn-back" onclick="prevStep(3)">‚Üê Back</button>
        <button class="btn-next" onclick="nextStep(3)">Continue ‚Üí</button>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê STEP 4: REVIEW & SUBMIT ‚ïê‚ïê‚ïê -->
    <div class="step-panel" id="panel-4">
      <h1 class="panel-title">Review Your Transaction</h1>
      <p class="panel-sub">Please review all details carefully before submitting. Once submitted, your Transaction ID will be generated and you can track progress in the dashboard.</p>

      <div class="card">
        <div class="card-title">
          <div class="card-title-icon">üè∑Ô∏è</div>
          Transaction Summary
        </div>
        <div class="review-grid" id="reviewGrid">
          <!-- Populated by JS -->
        </div>
      </div>

      <div class="card">
        <div class="card-title">
          <div class="card-title-icon">üìÑ</div>
          TrustBridge Escrow Agreement
        </div>
        <div class="agreement-box">
          <h4>TrustBridge Escrow Service Agreement</h4>
          <p>By submitting this transaction, you ("the Initiating Party") agree to the following terms and conditions set forth by TrustBridge Financial Services, Inc. ("TrustBridge").</p><br>
          <p><strong>1. Role of TrustBridge.</strong> TrustBridge acts solely as a neutral third-party escrow holder. TrustBridge does not take ownership of, or any interest in, the goods, services, or funds involved in any transaction.</p><br>
          <p><strong>2. Fund Handling.</strong> All funds held in escrow are maintained in segregated, FDIC-insured accounts. TrustBridge will not release funds until the conditions of the transaction, as agreed to by both parties, are fulfilled or a dispute is resolved.</p><br>
          <p><strong>3. Inspection Period.</strong> The buyer has the agreed inspection period to inspect goods or services. If no action is taken before the inspection period expires, funds will automatically be released to the seller.</p><br>
          <p><strong>4. Dispute Resolution.</strong> In the event of a dispute, TrustBridge's professional dispute resolution team will review submitted evidence from both parties and issue a binding determination within 10 business days.</p><br>
          <p><strong>5. Cancellation.</strong> Either party may request a cancellation prior to the seller delivering. Both parties must agree to cancel. If the buyer initiates a cancellation after delivery, the normal dispute process applies.</p><br>
          <p><strong>6. Fees.</strong> Fees are as disclosed at the time of transaction creation and are non-refundable once a transaction is initiated, except in cases of platform error.</p>
        </div>

        <div class="checkbox-row">
          <input type="checkbox" id="agree-terms" />
          <label for="agree-terms">I have read and agree to the <a href="#">TrustBridge Escrow Agreement</a> and <a href="#">Terms of Service</a>.</label>
        </div>
        <div class="checkbox-row">
          <input type="checkbox" id="agree-privacy" />
          <label for="agree-privacy">I agree to the <a href="#">Privacy Policy</a> and consent to my information being used for the purpose of this transaction.</label>
        </div>
        <div class="checkbox-row">
          <input type="checkbox" id="agree-accurate" />
          <label for="agree-accurate">I confirm that all information I have provided is accurate and that I am authorized to initiate this transaction.</label>
        </div>
        <p class="field-error" id="agree-error">Please accept all agreements to continue.</p>
      </div>

      <div class="nav-buttons">
        <button class="btn-back" onclick="prevStep(4)">‚Üê Back</button>
        <button class="btn-submit" onclick="submitTransaction()">
          üîí Submit Transaction
        </button>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê STEP 5: PAYMENT INSTRUCTIONS ‚ïê‚ïê‚ïê -->
    <div class="step-panel" id="panel-5">
      <div class="success-panel">

        <div class="success-icon">üîí</div>
        <h1 class="success-title">Send Your Payment</h1>
        <p class="success-sub">
          Your transaction has been created. Choose a cryptocurrency below and send the exact amount to the corresponding TrustBridge escrow address. Funds will be held securely until both parties fulfil the transaction conditions.
        </p>

        <!-- TX ID -->
        <div class="tx-id-box">
          <div>
            <div class="tx-id-label">Transaction ID ‚Äî Save this to check your dashboard</div>
            <div class="tx-id-value" id="generatedTxId">TBR-0000000</div>
          </div>
          <div class="copy-btn" onclick="copyTxId()">Copy</div>
        </div>

        <!-- ‚îÄ‚îÄ COUNTDOWN TIMER ‚îÄ‚îÄ -->
        <div id="paymentTimer" style="
          background: linear-gradient(135deg, #e53e3e, #c0392b);
          border-radius: 14px;
          padding: 1.1rem 1.5rem;
          max-width: 560px;
          margin: 0 auto 1.5rem;
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 1rem;
          box-shadow: 0 4px 20px rgba(229,62,62,0.3);
        ">
          <div style="display:flex;align-items:center;gap:10px;">
            <span style="font-size:1.4rem;">‚è±Ô∏è</span>
            <div>
              <div style="font-size:0.7rem;font-weight:700;color:rgba(255,255,255,0.7);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:2px;">Time to Send Payment</div>
              <div style="font-size:0.78rem;color:rgba(255,255,255,0.6);line-height:1.4;">Send funds within the window to secure your transaction</div>
            </div>
          </div>
          <div id="timerDisplay" style="
            font-family: 'Playfair Display', serif;
            font-size: 2.2rem;
            font-weight: 700;
            color: white;
            letter-spacing: 0.05em;
            white-space: nowrap;
            flex-shrink: 0;
          ">3:00</div>
        </div>
        <div id="timerExpired" style="
          display:none;
          background: rgba(229,62,62,0.08);
          border: 1px solid rgba(229,62,62,0.3);
          border-radius:10px;
          padding:0.9rem 1.2rem;
          max-width:560px;
          margin:0 auto 1.5rem;
          font-size:0.85rem;
          color:#c0392b;
          text-align:center;
          font-weight:600;
        ">‚ö†Ô∏è Time window expired. If you still plan to send, please contact support with your Transaction ID.</div>

        <!-- Payment card -->
        <div class="card" style="text-align:left; max-width:560px; margin:0 auto 1.5rem;">

          <!-- Critical warning -->
          <div style="
            background: rgba(229,62,62,0.07);
            border: 1px solid rgba(229,62,62,0.25);
            border-radius: 10px;
            padding: 0.9rem 1.1rem;
            display: flex; gap: 10px; align-items: flex-start;
            margin-bottom: 1.5rem;
          ">
            <span style="font-size:1rem; flex-shrink:0;">üö®</span>
            <p style="font-size:0.8rem; color:#8b1a1a; line-height:1.6; margin:0;">
              <strong>Only send the matching cryptocurrency to each address.</strong> Sending BTC to an ETH address, or ETH to a SOL address, will result in <strong>permanent, unrecoverable loss of funds.</strong> Always double-check you are using the correct address for the coin you are sending.
            </p>
          </div>

          <!-- Amount display -->
          <div style="
            background: linear-gradient(135deg, var(--navy), var(--navy-mid));
            border-radius:12px; padding:1.4rem 1.5rem;
            margin-bottom:1.5rem;
          ">
            <div style="font-size:0.72rem; font-weight:700; color:rgba(255,255,255,0.45); text-transform:uppercase; letter-spacing:0.1em; margin-bottom:0.5rem;">
              Total Amount Due
            </div>
            <div style="display:flex; align-items:center; justify-content:space-between; gap:1rem;">
              <div id="paymentAmountDisplay" style="font-family:'Playfair Display',serif; font-size:2rem; font-weight:700; color:white; word-break:break-all;">
                0.00
              </div>
            </div>
            <div style="font-size:0.75rem; color:rgba(255,255,255,0.4); margin-top:0.4rem;">
              Includes $250.00 escrow fee. Send this exact USD-equivalent amount in your chosen crypto ‚Äî do not round.
            </div>
          </div>

          <!-- Crypto address cards -->
          <div style="font-size:0.82rem; font-weight:700; color:var(--navy); margin-bottom:0.9rem;">Choose Your Cryptocurrency & Copy the Correct Address</div>

          <!-- BTC -->
          <div style="
            border: 2px solid #f7931a33;
            border-radius: 12px;
            padding: 1.1rem 1.2rem;
            margin-bottom: 0.9rem;
            background: #fffbf5;
          ">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:0.8rem;">
              <span style="font-size:1.5rem;">‚Çø</span>
              <div>
                <div style="font-size:0.95rem;font-weight:700;color:#b45309;">Bitcoin (BTC)</div>
                <div style="font-size:0.72rem;color:#92400e;">Only send BTC to this address. Do not send any other coin here.</div>
              </div>
            </div>
            <div style="
              background:white; border:1.5px solid #f7931a44;
              border-radius:8px; padding:0.8rem 1rem;
              display:flex; align-items:center; justify-content:space-between; gap:0.8rem;
            ">
              <code style="font-size:0.72rem;color:#1a1a1a;word-break:break-all;font-family:monospace;line-height:1.5;flex:1;">bc1qqgu5qy8wngq5c45qfkmww5xvu3levcqdj9vkme</code>
              <button onclick="copyAddr('bc1qqgu5qy8wngq5c45qfkmww5xvu3levcqdj9vkme', this)" style="
                background:#f7931a;border:none;border-radius:6px;color:white;
                font-size:0.75rem;font-weight:700;padding:0.45rem 0.85rem;
                cursor:pointer;white-space:nowrap;flex-shrink:0;transition:opacity 0.2s;
              " onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">Copy BTC</button>
            </div>
          </div>

          <!-- ETH -->
          <div style="
            border: 2px solid #627eea33;
            border-radius: 12px;
            padding: 1.1rem 1.2rem;
            margin-bottom: 0.9rem;
            background: #f7f8ff;
          ">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:0.8rem;">
              <span style="font-size:1.5rem;">‚ü†</span>
              <div>
                <div style="font-size:0.95rem;font-weight:700;color:#3730a3;">Ethereum (ETH)</div>
                <div style="font-size:0.72rem;color:#4338ca;">Only send ETH on the Ethereum mainnet to this address. Do not send ERC-20 tokens or use another network.</div>
              </div>
            </div>
            <div style="
              background:white; border:1.5px solid #627eea44;
              border-radius:8px; padding:0.8rem 1rem;
              display:flex; align-items:center; justify-content:space-between; gap:0.8rem;
            ">
              <code style="font-size:0.72rem;color:#1a1a1a;word-break:break-all;font-family:monospace;line-height:1.5;flex:1;">0xEa1F47aB0b93E2058578A60457F975cAC20Aa890</code>
              <button onclick="copyAddr('0xEa1F47aB0b93E2058578A60457F975cAC20Aa890', this)" style="
                background:#627eea;border:none;border-radius:6px;color:white;
                font-size:0.75rem;font-weight:700;padding:0.45rem 0.85rem;
                cursor:pointer;white-space:nowrap;flex-shrink:0;transition:opacity 0.2s;
              " onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">Copy ETH</button>
            </div>
          </div>

          <!-- SOL -->
          <div style="
            border: 2px solid #9945ff33;
            border-radius: 12px;
            padding: 1.1rem 1.2rem;
            margin-bottom: 0.5rem;
            background: #fdf7ff;
          ">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:0.8rem;">
              <span style="font-size:1.5rem;">‚óé</span>
              <div>
                <div style="font-size:0.95rem;font-weight:700;color:#6b21a8;">Solana (SOL)</div>
                <div style="font-size:0.72rem;color:#7e22ce;">Only send native SOL to this address. Do not send SPL tokens (USDC, USDT, etc.) here.</div>
              </div>
            </div>
            <div style="
              background:white; border:1.5px solid #9945ff44;
              border-radius:8px; padding:0.8rem 1rem;
              display:flex; align-items:center; justify-content:space-between; gap:0.8rem;
            ">
              <code style="font-size:0.72rem;color:#1a1a1a;word-break:break-all;font-family:monospace;line-height:1.5;flex:1;">A7R9bY8ufHM5eUa9TUuiommJvgcsuuiTHha7ZKD3RVws</code>
              <button onclick="copyAddr('A7R9bY8ufHM5eUa9TUuiommJvgcsuuiTHha7ZKD3RVws', this)" style="
                background:#9945ff;border:none;border-radius:6px;color:white;
                font-size:0.75rem;font-weight:700;padding:0.45rem 0.85rem;
                cursor:pointer;white-space:nowrap;flex-shrink:0;transition:opacity 0.2s;
              " onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">Copy SOL</button>
            </div>
          </div>

          <div style="font-size:0.74rem;color:var(--text-light);margin-top:0.7rem;line-height:1.6;padding:0.7rem;background:var(--off-white);border-radius:8px;">
            üîí Verify the full address in your wallet before confirming. TrustBridge will <strong>never</strong> ask you to send funds to a different address than shown here.
          </div>

        </div>

        <!-- What Happens Next -->
        <div class="card" style="text-align:left; max-width:560px; margin:0 auto 2rem;">
          <div class="card-title"><div class="card-title-icon">üìã</div>What Happens After You Send</div>
          <div class="review-grid">
            <div class="review-item">
              <span class="review-key">1. You send crypto</span>
              <span class="review-val">Transfer the exact USD-equivalent to the correct address for your chosen coin</span>
            </div>
            <div class="review-item">
              <span class="review-key">2. We confirm receipt</span>
              <span class="review-val">TrustBridge verifies the payment on-chain (usually within minutes)</span>
            </div>
            <div class="review-item">
              <span class="review-key">3. Other party notified</span>
              <span class="review-val">The seller is notified that funds are secured and to proceed with delivery</span>
            </div>
            <div class="review-item">
              <span class="review-key">4. Inspect & approve</span>
              <span class="review-val">You have <span id="inspectionSummary">3 days</span> to inspect before funds auto-release</span>
            </div>
            <div class="review-item" style="border-bottom:none;">
              <span class="review-key">5. Funds released</span>
              <span class="review-val">Once you approve, crypto is released to the seller minus the escrow fee</span>
            </div>
          </div>
        </div>

        <div class="success-actions">
          <a href="dashboard.html" class="btn-primary-full">Track Your Transaction ‚Üí</a>
          <a href="index.html" class="btn-outline">Back to Home</a>
        </div>

      </div>
    </div>

  </div><!-- /main -->
</div><!-- /page-wrap -->

<script>
  // ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
  const state = {
    currentStep: 1,
    maxUnlocked: 1,
    category: null,
    amount: 0,
    currency: 'USD',
    paymentMethod: '',
    title: '',
    description: '',
    inspection: '3',
    feePayer: 'buyer',
    role: 'buyer',
    myFirst: '', myLast: '', myEmail: '', myPhone: '', myCountry: '', myAccountType: 'individual', myCompany: ''
  };

  // ‚îÄ‚îÄ CATEGORY SELECTION ‚îÄ‚îÄ
  function selectCategory(option) {
    document.querySelectorAll('.cat-option').forEach(o => o.classList.remove('selected'));
    option.classList.add('selected');
    state.category = option.dataset.value;
    document.getElementById('cat-error').classList.remove('show');
  }

  document.getElementById('categoryGrid').addEventListener('click', function(e) {
    const option = e.target.closest('.cat-option');
    if (option) selectCategory(option);
  });

  // ‚îÄ‚îÄ INSPECTION SELECTION ‚îÄ‚îÄ
  function selectInspection(el) {
    document.querySelectorAll('.inspection-pill').forEach(p => p.classList.remove('selected'));
    el.classList.add('selected');
    state.inspection = el.dataset.value;
  }

  // ‚îÄ‚îÄ FEE PAYER ‚îÄ‚îÄ
  function selectFeePayer(el) {
    document.querySelectorAll('.fee-split-card').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    state.feePayer = el.dataset.value;
    updateFee();
  }

  // ‚îÄ‚îÄ MIDDLEMAN CUSTOM DROPDOWN ‚îÄ‚îÄ
  const middlemen = ['Cold','Fame','Tall','Grin','Poor','Hand','Poem','Wine','Torn','Underground'];

  // SVG verified badge ‚Äî same blue as site
  function verifiedBadge() {
    return `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="flex-shrink:0;margin-left:4px;vertical-align:middle;display:inline-block;">
      <path d="M12 2C10.343 2 8.837 2.627 7.686 3.657L4.929 2.929C4.379 2.773 3.797 2.929 3.394 3.332C2.991 3.735 2.835 4.317 2.991 4.867L3.707 7.586C2.634 8.747 2 10.299 2 12C2 16.418 5.582 20 10 20H12C16.418 20 20 16.418 20 12C20 7.582 16.418 4 12 4V2Z" fill="none"/>
      <path d="M12 1L14.5 3.5H18.5L19.5 7.5L22 10L19.5 12.5L18.5 16.5H14.5L12 19L9.5 16.5H5.5L4.5 12.5L2 10L4.5 7.5L5.5 3.5H9.5L12 1Z" fill="#2477d4"/>
      <path d="M8.5 10.5L11 13L15.5 8" stroke="white" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>`;
  }

  function buildMmList() {
    const list = document.getElementById('mm-list');
    list.innerHTML = middlemen.map(name => `
      <div onclick="selectMiddleman('${name}')" style="
        display:flex;align-items:center;
        padding:0.75rem 1rem;cursor:pointer;
        transition:background 0.15s;font-size:0.92rem;font-weight:500;color:var(--navy);
        border-bottom:1px solid var(--light-gray);
      "
      onmouseover="this.style.background='#f0f5ff'"
      onmouseout="this.style.background=''"
      id="mm-opt-${name}">
        <span>${name}</span>${verifiedBadge()}
      </div>
    `).join('').replace(/border-bottom:1px solid var\(--light-gray\);\s*">\s*<span>Underground/, 'border-bottom:none;">\n        <span>Underground');
  }

  function toggleMmDropdown() {
    const list = document.getElementById('mm-list');
    const chevron = document.getElementById('mm-chevron');
    const trigger = document.getElementById('mm-trigger');
    const open = list.style.display === 'block';
    list.style.display = open ? 'none' : 'block';
    chevron.style.transform = open ? '' : 'rotate(180deg)';
    trigger.style.borderColor = open ? 'var(--light-gray)' : 'var(--blue-bright)';
    trigger.style.boxShadow = open ? 'none' : '0 0 0 3px rgba(36,119,212,0.12)';
    if (!open) buildMmList();
  }

  function selectMiddleman(name) {
    // Update hidden select
    const sel = document.getElementById('middleman-select');
    sel.value = name;
    // Update trigger label
    const label = document.getElementById('mm-trigger-label');
    label.style.color = 'var(--text-dark)';
    label.style.fontWeight = '600';
    label.innerHTML = `<span style="display:flex;align-items:center;gap:2px;">${name} ${verifiedBadge()}</span>`;
    // Close dropdown
    document.getElementById('mm-list').style.display = 'none';
    document.getElementById('mm-chevron').style.transform = '';
    document.getElementById('mm-trigger').style.borderColor = 'var(--blue-bright)';
    document.getElementById('mm-trigger').style.boxShadow = 'none';
    // Show preview
    updateMiddlemanPreview(sel);
    hideError('middleman-error', null);
  }

  // Close dropdown if clicking outside
  document.addEventListener('click', function(e) {
    const wrap = document.getElementById('mm-dropdown-wrap');
    if (wrap && !wrap.contains(e.target)) {
      document.getElementById('mm-list').style.display = 'none';
      document.getElementById('mm-chevron').style.transform = '';
    }
  });

  function updateMiddlemanPreview(sel) {
    const preview = document.getElementById('middleman-preview');
    const avatar  = document.getElementById('middleman-avatar');
    const nameEl  = document.getElementById('middleman-name');
    if (!sel.value) { preview.style.display = 'none'; return; }
    avatar.textContent = sel.value.charAt(0).toUpperCase();
    nameEl.textContent = sel.value;
    preview.style.display = 'flex';
  }

  // ‚îÄ‚îÄ ROLE SELECTION ‚îÄ‚îÄ
  function selectRole(el) {
    document.querySelectorAll('.role-card').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    state.role = el.dataset.value;
  }

  // ‚îÄ‚îÄ ACCOUNT TYPE (show/hide company) ‚îÄ‚îÄ
  document.getElementById('my-account-type').addEventListener('change', function() {
    document.getElementById('company-row').style.display = this.value === 'business' ? 'flex' : 'none';
  });

  // ‚îÄ‚îÄ FEE CALCULATION ‚îÄ‚îÄ
  const ESCROW_FEE = 250;

  function updateFee() {
    const amt = parseFloat(document.getElementById('amount').value) || 0;
    state.amount = amt;
    const sym = getSymbol(document.getElementById('currency').value);

    const method = document.getElementById('payment-method').value;
    let procFee = 0;
    if (method === 'card') procFee = amt * 0.029 + 0.30;
    else if (method === 'wire') procFee = 30;
    else if (method === 'crypto') procFee = amt * 0.01;

    const total = amt + ESCROW_FEE + procFee;

    document.getElementById('fee-amount-display').textContent = sym + fmt(amt);
    document.getElementById('fee-escrow-display').textContent = sym + fmt(ESCROW_FEE);
    document.getElementById('fee-processing-display').textContent = procFee ? sym + fmt(procFee) : 'Free';
    document.getElementById('fee-total-display').textContent = sym + fmt(total);
  }

  function getSymbol(code) {
    const map = { USD:'$', CAD:'CA$', GBP:'¬£', EUR:'‚Ç¨', AUD:'A$' };
    return map[code] || '$';
  }
  function fmt(n) { return n.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ','); }

  document.getElementById('currency').addEventListener('change', updateFee);
  document.getElementById('payment-method').addEventListener('change', updateFee);

  // ‚îÄ‚îÄ STEP NAVIGATION ‚îÄ‚îÄ
  function goToStep(n) {
    if (n > state.maxUnlocked) return;
    showStep(n);
  }

  function nextStep(from) {
    if (!validateStep(from)) return;
    state.maxUnlocked = Math.max(state.maxUnlocked, from + 1);
    if (from === 3) buildReview();
    showStep(from + 1);
  }

  function prevStep(from) {
    showStep(from - 1);
  }

  function showStep(n) {
    document.querySelectorAll('.step-panel').forEach(p => p.classList.remove('active'));
    document.getElementById('panel-' + n).classList.add('active');

    document.querySelectorAll('.step-tab').forEach(t => {
      const s = parseInt(t.dataset.step);
      t.classList.remove('active', 'done', 'locked');
      if (s < n) t.classList.add('done');
      else if (s === n) t.classList.add('active');
      else if (s <= state.maxUnlocked) t.classList.remove('locked');
      else t.classList.add('locked');
    });

    document.querySelectorAll('.step-tab').forEach(t => {
      const s = parseInt(t.dataset.step);
      const bubble = t.querySelector('.step-bubble');
      bubble.textContent = s < n ? '‚úì' : s;
    });

    state.currentStep = n;
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // ‚îÄ‚îÄ VALIDATION ‚îÄ‚îÄ
  function validateStep(step) {
    let ok = true;

    if (step === 1) {
      if (!state.category) {
        document.getElementById('cat-error').classList.add('show');
        ok = false;
      }
    }

    if (step === 2) {
      const amt = parseFloat(document.getElementById('amount').value);
      if (!amt || amt <= 0) {
        showError('amount-error', 'amount'); ok = false;
      } else { hideError('amount-error', 'amount'); }

      if (!document.getElementById('payment-method').value) {
        showError('payment-error', 'payment-method'); ok = false;
      } else { hideError('payment-error', 'payment-method'); }

      if (!document.getElementById('tx-title').value.trim()) {
        showError('title-error', 'tx-title'); ok = false;
      } else { hideError('title-error', 'tx-title'); }
    }

    if (step === 3) {
      const fields = [
        { id: 'my-first', err: 'my-first-error' },
        { id: 'my-last', err: 'my-last-error' },
      ];
      fields.forEach(f => {
        const val = document.getElementById(f.id).value.trim();
        if (!val) { showError(f.err, f.id); ok = false; }
        else { hideError(f.err, f.id); }
      });

      // Validate counterparty username
      const cpInput = document.getElementById('counterparty-username').value.trim();
      const cpStatus = document.getElementById('counterparty-status');
      const currentUser = TBAuth.getUser();
      if (!cpInput) {
        showError('counterparty-error', 'counterparty-username'); ok = false;
        cpStatus.textContent = '';
      } else if (currentUser && cpInput.toLowerCase() === currentUser.username.toLowerCase()) {
        showError('counterparty-error', 'counterparty-username');
        document.getElementById('counterparty-error').textContent = 'You cannot invite yourself.';
        ok = false;
      } else {
        hideError('counterparty-error', 'counterparty-username');
        document.getElementById('counterparty-error').textContent = 'Please enter the other party\'s username.';
        if (TBAuth.usernameExists(cpInput)) {
          cpStatus.innerHTML = '<span style="color:#27a85e;font-weight:600;">‚úì Username found on TrustBridge</span>';
        } else {
          cpStatus.innerHTML = '<span style="color:#e07b20;">‚ö† Username not found ‚Äî they\'ll need to create an account to accept.</span>';
        }
      }

      // Validate middleman selection
      const mm = document.getElementById('middleman-select').value;
      if (!mm) {
        showError('middleman-error', null);
        document.getElementById('mm-trigger').style.borderColor = 'var(--red)';
        ok = false;
      } else {
        hideError('middleman-error', null);
        document.getElementById('mm-trigger').style.borderColor = 'var(--blue-bright)';
      }
    }

    return ok;
  }

  function showError(errId, inputId) {
    document.getElementById(errId).classList.add('show');
    if (inputId) document.getElementById(inputId)?.classList.add('error');
  }
  function hideError(errId, inputId) {
    document.getElementById(errId).classList.remove('show');
    if (inputId) document.getElementById(inputId)?.classList.remove('error');
  }

  // ‚îÄ‚îÄ BUILD REVIEW ‚îÄ‚îÄ
  function buildReview() {
    const categoryLabels = {
      domain:'Domain Name', 'real-estate':'Real Estate', vehicle:'Motor Vehicle',
      tech:'Tech / Software', luxury:'Luxury Goods', business:'Business Sale',
      digital:'Digital Assets', services:'Services'
    };
    const paymentLabels = {
      wire:'Wire Transfer', ach:'ACH / Bank Transfer', card:'Credit / Debit Card', crypto:'Cryptocurrency'
    };
    const feePayerLabels = { buyer:'Buyer Pays', seller:'Seller Pays', split:'Split 50/50' };
    const sym = getSymbol(document.getElementById('currency').value);
    const amt = parseFloat(document.getElementById('amount').value) || 0;

    const rows = [
      { k: 'Category', v: categoryLabels[state.category] || state.category, step: 1 },
      { k: 'Transaction Title', v: document.getElementById('tx-title').value, step: 2 },
      { k: 'Amount', v: sym + fmt(amt) + ' ' + document.getElementById('currency').value, step: 2 },
      { k: 'Escrow Fee', v: '$250.00 USD (flat)', step: 2 },
      { k: 'Payment Method', v: paymentLabels[document.getElementById('payment-method').value] || '‚Äî', step: 2 },
      { k: 'Inspection Period', v: state.inspection + ' day(s)', step: 2 },
      { k: 'Fee Payer', v: feePayerLabels[state.feePayer], step: 2 },
      { k: 'Your Role', v: state.role === 'buyer' ? 'Buyer' : 'Seller', step: 3 },
      { k: 'Your Name', v: document.getElementById('my-first').value + ' ' + document.getElementById('my-last').value, step: 3 },
      { k: 'Other Party (Username)', v: document.getElementById('counterparty-username').value, step: 3 },
      { k: 'Middle-Man Host', v: document.getElementById('middleman-select').value ? '‚úî ' + document.getElementById('middleman-select').value + ' (Verified)' : '‚Äî', step: 3 },
    ];

    const grid = document.getElementById('reviewGrid');
    grid.innerHTML = rows.map(r => `
      <div class="review-item">
        <span class="review-key">${r.k}</span>
        <span class="review-val">
          ${r.v || '<em style="color:var(--text-light)">Not provided</em>'}
          <span class="review-edit" onclick="goToStep(${r.step})">Edit</span>
        </span>
      </div>
    `).join('');
  }

  // ‚îÄ‚îÄ SUBMIT ‚îÄ‚îÄ
  function submitTransaction() {
    const checks = ['agree-terms', 'agree-privacy', 'agree-accurate'];
    const allChecked = checks.every(id => document.getElementById(id).checked);
    if (!allChecked) {
      document.getElementById('agree-error').classList.add('show');
      return;
    }
    document.getElementById('agree-error').classList.remove('show');

    // Generate truly unique transaction ID
    const txId = 'TBR-' + Date.now().toString().slice(-7) + Math.floor(Math.random() * 100).toString().padStart(2,'0');
    document.getElementById('generatedTxId').textContent = txId;

    const amt = parseFloat(document.getElementById('amount').value) || 0;
    const totalUsdc = (amt + ESCROW_FEE).toFixed(2);
    document.getElementById('paymentAmountDisplay').textContent = fmt(parseFloat(totalUsdc)) + ' USDC';

    window._paymentAmount = totalUsdc;

    document.getElementById('inspectionSummary').textContent = state.inspection + ' day(s)';

    // Save transaction to current user's account
    const categoryLabels = {
      domain:'Domain Name', 'real-estate':'Real Estate', vehicle:'Motor Vehicle',
      tech:'Tech / Software', luxury:'Luxury Goods', business:'Business Sale',
      digital:'Digital Assets', services:'Services'
    };
    TBAuth.saveTransaction(txId, {
      title: document.getElementById('tx-title').value,
      category: categoryLabels[state.category] || state.category,
      amount: amt,
      currency: document.getElementById('currency').value,
      status: 'Awaiting Payment',
      role: state.role === 'buyer' ? 'Buyer' : 'Seller',
      name: document.getElementById('my-first').value + ' ' + document.getElementById('my-last').value,
      counterparty: document.getElementById('counterparty-username').value,
      middleman: document.getElementById('middleman-select').value,
      createdAt: new Date().toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'})
    });

    document.querySelectorAll('.step-tab').forEach(t => {
      t.classList.remove('active', 'locked');
      t.classList.add('done');
      t.querySelector('.step-bubble').textContent = '‚úì';
    });

    document.querySelectorAll('.step-panel').forEach(p => p.classList.remove('active'));
    document.getElementById('panel-5').classList.add('active');
    window.scrollTo({ top: 0, behavior: 'smooth' });

    // Start the 3-minute payment countdown
    startPaymentTimer();
  }

  // ‚îÄ‚îÄ COPY FUNCTIONS ‚îÄ‚îÄ
  function copyTxId() {
    const id = document.getElementById('generatedTxId').textContent;
    navigator.clipboard.writeText(id).then(() => {
      const btn = document.querySelector('.copy-btn');
      const orig = btn.textContent;
      btn.textContent = 'Copied!';
      setTimeout(() => btn.textContent = orig, 2000);
    });
  }

  function copyAddr(address, btn) {
    navigator.clipboard.writeText(address).then(() => {
      const orig = btn.textContent;
      btn.textContent = '‚úì Copied!';
      btn.style.opacity = '1';
      setTimeout(() => btn.textContent = orig, 2500);
    }).catch(() => alert('Could not copy. Please copy the address manually.'));
  }

  // ‚îÄ‚îÄ COUNTDOWN TIMER ‚îÄ‚îÄ
  let _timerInterval = null;

  function startPaymentTimer() {
    let secondsLeft = 180; // 3 minutes
    const display = document.getElementById('timerDisplay');
    const timerBox = document.getElementById('paymentTimer');
    const expiredBox = document.getElementById('timerExpired');

    if (_timerInterval) clearInterval(_timerInterval);

    _timerInterval = setInterval(() => {
      secondsLeft--;
      const m = Math.floor(secondsLeft / 60);
      const s = secondsLeft % 60;
      display.textContent = m + ':' + String(s).padStart(2, '0');

      // Turn orange under 1 min
      if (secondsLeft <= 60 && secondsLeft > 30) {
        timerBox.style.background = 'linear-gradient(135deg, #e07b20, #c0620a)';
        timerBox.style.boxShadow = '0 4px 20px rgba(224,123,32,0.4)';
      }
      // Flash red under 30 sec
      if (secondsLeft <= 30) {
        timerBox.style.background = 'linear-gradient(135deg, #e53e3e, #9b1c1c)';
        display.style.animation = 'timerPulse 0.8s infinite';
      }

      if (secondsLeft <= 0) {
        clearInterval(_timerInterval);
        timerBox.style.display = 'none';
        expiredBox.style.display = 'block';
      }
    }, 1000);
  }

  // ‚îÄ‚îÄ AUTO-SELECT CATEGORY FROM URL PARAM ‚îÄ‚îÄ
  window.addEventListener('DOMContentLoaded', () => {
    // Require login to use this page
    TBAuthUI.init({ requireAuth: true });

    // Auto-fill username from logged-in account
    const user = TBAuth.getUser();
    if (user) {
      // Pre-fill first name with username as a convenience hint
      document.getElementById('my-first').placeholder = user.username;
    }

    // Live counterparty username check
    document.getElementById('counterparty-username').addEventListener('input', function() {
      const val = this.value.trim();
      const cpStatus = document.getElementById('counterparty-status');
      const currentUser = TBAuth.getUser();
      if (!val) { cpStatus.textContent = ''; return; }
      if (currentUser && val.toLowerCase() === currentUser.username.toLowerCase()) {
        cpStatus.innerHTML = '<span style="color:#e53e3e;">‚úó You cannot invite yourself.</span>';
        return;
      }
      if (TBAuth.usernameExists(val)) {
        cpStatus.innerHTML = '<span style="color:#27a85e;font-weight:600;">‚úì Username found on TrustBridge</span>';
      } else {
        cpStatus.innerHTML = '<span style="color:#e07b20;">‚ö† Username not found ‚Äî they\'ll need to create an account to accept.</span>';
      }
    });

    const params = new URLSearchParams(window.location.search);
    const cat = params.get('cat');
    if (cat) {
      const el = document.querySelector(`.cat-option[data-value="${cat}"]`);
      if (el) selectCategory(el);
    }
  });
</script>
</body>
</html>
